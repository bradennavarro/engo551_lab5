<!DOCTYPE html>
<html>
<head>
    <title>ENGO 551 Lab 5</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Add your CSS styles here */
    </style>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
</head>
<body>
    <h1>MQTT Client Example</h1>

    <!-- Form for MQTT connection -->
    <form id="connform">
        Server: <input type="text" name="server" value="test.mosquitto.org"><br>
        Port: <input type="text" name="port" value="8080"><br>
        <button onclick="MQTTconnect()">Start</button>
        <button onclick="endConnection()">End</button>
    </form>

    <!-- Form for subscribing to topics -->
    <form id="subs">
        Subscribe to Topic: <input type="text" name="Stopic"><br>
        <button onclick="sub_topics()">Subscribe</button>
    </form>

    <!-- Form for sending messages -->
    <form id="smessage">
        Publish Message: <input type="text" name="message"><br>
        Topic: <input type="text" name="Ptopic"><br>
        <button onclick="send_message()">Send</button>
    </form>

    <!-- Status and Messages display -->
    <div id="status"></div>
    <div id="messages"></div>

    <button id="find-me">Show my location</button><br />
    <p id="geostatus"></p>
    <a id="map-link" target="_blank"></a>

    <script type="text/javascript">
        var host = "test.mosquitto.org"; // Default MQTT server
        var port = 8080; // Default MQTT port
        var reconnectTimeout = 2000; // Timeout for reconnection attempt
        var connected_flag = false; // Connection status flag

        var mqtt; // MQTT client object

        function onConnectionLost(response) {
            console.log("Connection lost: " + response.errorMessage);
            document.getElementById("status").innerHTML = "Connection Lost";
            document.getElementById("messages").innerHTML = "Connection Lost";
            connected_flag = false;
        }

        function onFailure(message) {
            console.log("Connection failed: " + message.errorMessage);
            document.getElementById("messages").innerHTML = "Connection Failed - Retrying...";
            setTimeout(MQTTconnect, reconnectTimeout);
        }

        function onMessageArrived(message) {
            var payload = message.payloadString;
            console.log("Message received: " + payload);
            document.getElementById("messages").innerHTML = payload;
        }

        function onConnect() {
            console.log("Connected to " + host + " on port " + port);
            document.getElementById("messages").innerHTML = "Connected to " + host + " on port " + port;
            document.getElementById("status").innerHTML = "Connected";
            connected_flag = true;
        }

        function endConnection() {
            if (mqttClient && connectedFlag) {
                mqttClient.disconnect();
                connectedFlag = false;
                console.log('Disconnected from MQTT broker.');
            }
        }

        function MQTTconnect() {
            event.preventDefault();
            var server = document.forms["connform"]["server"].value;
            var p = document.forms["connform"]["port"].value;
            if (server != "") host = server;
            if (p != "") port = parseInt(p);

            console.log("Connecting to " + host + " on port " + port);
            mqtt = new Paho.MQTT.Client(host, port, "clientID_" + parseInt(Math.random() * 100));
            var options = {
                timeout: 4000,
                onSuccess: onConnect,
                onFailure: onFailure,
            };

            mqtt.onConnectionLost = onConnectionLost;
            mqtt.onMessageArrived = onMessageArrived;

            mqtt.connect(options);
            return false;
        }

        function sub_topics() {
            event.preventDefault();
            if (connected_flag == false) {
                console.log("Not connected, cannot subscribe.");
                document.getElementById("messages").innerHTML = "<b>Not connected, cannot subscribe.</b>";
                return false;
            }
            var stopic = document.forms["subs"]["Stopic"].value;
            console.log("Subscribing to topic: " + stopic);
            mqtt.subscribe(stopic);
            return false;
        }

        function send_message() {
            event.preventDefault();
            if (connected_flag === false) {
                console.log("Not connected, cannot send message.");
                document.getElementById("messages").innerHTML = "<b>Not connected, cannot send message.</b>";
                return false;
            }
            var msg = document.forms["smessage"]["message"].value;
            var topic = document.forms["smessage"]["Ptopic"].value;
            console.log("Sending message: " + msg + " to topic: " + topic);

            var message = new Paho.MQTT.Message(msg);
            message.destinationName = topic || "test-topic";
            mqtt.send(message);
            return false;
        }

        function geoFindMe() {
            const status = document.querySelector("#geostatus");
            const mapLink = document.querySelector("#map-link");

            mapLink.href = "";
            mapLink.textContent = "";

            function success(position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                status.textContent = "";
                mapLink.href = `https://www.openstreetmap.org/#map=18/${latitude}/${longitude}`;
                mapLink.textContent = `Latitude: ${latitude} °, Longitude: ${longitude} °`;
            }

            function error() {
                status.textContent = "Unable to retrieve your location";
            }

            if (!navigator.geolocation) {
                status.textContent = "Geolocation is not supported by your browser";
            } else {
                status.textContent = "Locating…";
                navigator.geolocation.getCurrentPosition(success, error);
            }
        }

        document.querySelector("#find-me").addEventListener("click", geoFindMe);
    </script>
</body>
</html>
